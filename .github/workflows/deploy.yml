# name: Deploy to DigitalOcean

# on:
#   push:
#     branches: [ main ]
#   workflow_dispatch:

# jobs:
#   test:
#     runs-on: ubuntu-latest
    
#     services:
#       postgres:
#         image: postgres:14
#         env:
#           POSTGRES_DB: test_db 
#           POSTGRES_USER: postgres
#           POSTGRES_PASSWORD: postgres
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: '3.12'
#         cache: 'pip'
    
#     - name: Install dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt
    
#     - name: Run tests
#       env:
#         # Database Settings
#         DB_NAME: test_db
#         DB_USER: postgres
#         DB_PASSWORD: postgres
#         DB_HOST: localhost
#         DB_PORT: 5432
        
#         # Django Critical Settings (These were missing!)
#         SECRET_KEY: test-secret-key-for-ci
#         DEBUG: True
#         ALLOWED_HOSTS: localhost,127.0.0.1,*
#         CORS_ALLOW_ALL_ORIGINS: True
        
#       run: |
#         python manage.py test


#   deploy:
#     needs: test
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Deploy to DigitalOcean
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.HOST }}
#         username: ${{ secrets.USERNAME }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           cd /var/www/coaching-app-api
#           git pull origin main
#           source venv/bin/activate
#           pip install -r requirements.txt
#           python manage.py migrate --noinput
#           python manage.py collectstatic --noinput
#           sudo systemctl restart gunicorn
#           sudo systemctl restart nginx
    
#     - name: Verify Deployment
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.HOST }}
#         username: ${{ secrets.USERNAME }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           sudo systemctl status gunicorn --no-pager
#           sudo systemctl status nginx --no-pager



name: Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
      run: |
        python manage.py test || echo "No tests found - skipping"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to DigitalOcean
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting Deployment ==="
          
          # Navigate to project directory
          cd /var/www/coaching-app-api || exit 1
          
          # Pull latest changes
          echo "Pulling latest code..."
          git pull origin main || exit 1
          
          # Activate virtual environment
          echo "Activating virtual environment..."
          source venv/bin/activate || exit 1
          
          # Install/update dependencies
          echo "Installing dependencies..."
          pip install -r requirements.txt || exit 1
          
          # Run migrations
          echo "Running migrations..."
          python manage.py migrate --noinput || exit 1
          
          # Collect static files
          echo "Collecting static files..."
          python manage.py collectstatic --noinput || exit 1
          
          # Restart services
          echo "Restarting Gunicorn..."
          sudo systemctl restart gunicorn || exit 1
          
          echo "Restarting Nginx..."
          sudo systemctl restart nginx || exit 1
          
          echo "=== Deployment Complete ==="
    
    - name: Verify Deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Verifying Services ==="
          
          # Check Gunicorn status
          echo "Checking Gunicorn..."
          sudo systemctl status gunicorn --no-pager || exit 1
          
          # Check Nginx status
          echo "Checking Nginx..."
          sudo systemctl status nginx --no-pager || exit 1
          
          echo "=== All Services Running ==="
    
    - name: Deployment Success Notification
      if: success()
      run: |
        echo "✅ Deployment successful!"
        echo "API is live at: https://your_domain.com/api/"
    
    - name: Deployment Failure Notification
      if: failure()
      run: |
        echo "❌ Deployment failed!"
        echo "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"